<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fit Images · DirectDetections.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DirectDetections.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../getting-started/">Getting Started</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../modelling/">Fit Astrometry</a></li><li><a class="tocitem" href="../pma/">Fit Astrometric Acceleration</a></li><li class="is-active"><a class="tocitem" href>Fit Images</a><ul class="internal"><li><a class="tocitem" href="#Preparing-images"><span>Preparing images</span></a></li><li><a class="tocitem" href="#Build-the-model"><span>Build the model</span></a></li><li><a class="tocitem" href="#Sampling"><span>Sampling</span></a></li><li><a class="tocitem" href="#Diagnostics"><span>Diagnostics</span></a></li><li><a class="tocitem" href="#Analysis"><span>Analysis</span></a></li><li><a class="tocitem" href="#Pair-Plot"><span>Pair Plot</span></a></li><li><a class="tocitem" href="#Assessing-Detections"><span>Assessing Detections</span></a></li></ul></li><li><a class="tocitem" href="../derived/">Derived Variables</a></li><li><a class="tocitem" href="../mass-photometry/">Connecting Mass with Photometry</a></li><li><a class="tocitem" href="../loading-saving/">Loading and Saving Data</a></li></ul></li><li><span class="tocitem">Documentation</span><ul><li><a class="tocitem" href="../priors/">Priors</a></li><li><a class="tocitem" href="../samplers/">Samplers</a></li><li><a class="tocitem" href="../chains/">Chains</a></li><li><a class="tocitem" href="../kepler/">Kepler Solver</a></li><li><a class="tocitem" href="../api/">API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Fit Images</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fit Images</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/sefffal/DirectDetections.jl/blob/main/docs/src/images.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="fit-images"><a class="docs-heading-anchor" href="#fit-images">Fitting Images</a><a id="fit-images-1"></a><a class="docs-heading-anchor-permalink" href="#fit-images" title="Permalink"></a></h1><p>One of the key features of DirectDetections.jl is the ability to search for planets directly from images of the system. Sampling from images is much more computationally demanding than sampling from astrometry, but it allows for a few very powerful results:</p><ol><li>You can search for a planet that is not well detected in a single image</li></ol><p>By this, we mean you can feed in images of a system with no clear detections, and see if a planet is hiding in the noise based off of its Kepelerian motion.</p><ol><li>Not detecting a planet in a given image can be almost as useful as a detection for constraining its orbit. </li></ol><p>If you have a clear detection in one epoch, but no detection in another, DirectDetections can use the image from the second epoch to rule out large swathes of possible orbits.</p><p>Sampling from images can be freely combined with any known astrometry points, as well as astrometric acceleration. See advanced models for more details.</p><h2 id="Preparing-images"><a class="docs-heading-anchor" href="#Preparing-images">Preparing images</a><a id="Preparing-images-1"></a><a class="docs-heading-anchor-permalink" href="#Preparing-images" title="Permalink"></a></h2><p>The first step will be to load your images. For this, we will use our DirectImages.jl package; however, all that is really necessary is to load your image(s) into an array and adjust the axes so that the star is at index <code>[0,0]</code> (see OffsetArrays.jl if you want to do this yourself).</p><p>Start by loading your images:</p><pre><code class="language-julia hljs">using DirectImages

# Load individual iamges
# image1 = readfits(&quot;image1.fits&quot;)
# image2 = readfits(&quot;image2.fits&quot;)

# Or slices from a cube:
# cube = readfits(&quot;cube1.fits&quot;)
# image1 = cube[:,:,1] 

# Or multi-extension FITS (this example)
images = readfits(&quot;image-examples-1.fits&quot;,:)</code></pre><p>You can preview the image using <code>imshow2</code> from DirectImages:</p><pre><code class="language-julia hljs"># imshow2(image1, cmap=:magma) # for a single image
imshow2([
    images[1]
    images[2]
    images[3]
    images[4]
    images[5]
], cmap=:magma, clims=(-1.0, 4.0))</code></pre><p><img src="../assets/images-input.png" alt="images"/></p><p>Your images should either be convolved with a gaussian of diameter one λ/D, or be matched filtered. This is so that the values of the pixels in the image represent the photometry at that location. </p><p>If you want to perform the convolution in Julia, see ImageFiltering.jl.</p><h2 id="Build-the-model"><a class="docs-heading-anchor" href="#Build-the-model">Build the model</a><a id="Build-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Build-the-model" title="Permalink"></a></h2><p>Then, create a system with one or more planets. In this case, we will not provide any astrometry measurements for the planet, but they are supported with the same syntax as shown in the <a href="../modelling/#fit-astrometry">Fit Astrometry</a> tutorial.</p><p>Start by specifying a planet:</p><pre><code class="language-julia hljs">@named X = DirectDetections.Planet(
    Priors(
        a = Normal(13, 3),
        e = TruncatedNormal(0.2, 0.2, 0, 1.0),
        τ = Normal(0.5, 1),
        ω = Normal(0.1, deg2rad(30.)),
        i = Normal(0.6, deg2rad(10.)),
        Ω = Normal(0.0, deg2rad(30.)),
        H = Normal(3.8, 0.5)
    ),
)</code></pre><p>Note how we also provided a prior on the photometry called <code>H</code>. We can put any name we want here, as long as it&#39;s used consistently throughout the model specification.</p><p>See <a href="../modelling/#fit-astrometry">Fit Astrometry</a> for a description of the different orbital parameters, and conventions used.</p><p>Now, we create a table of images that will be passed to the <code>System</code>:</p><pre><code class="language-julia hljs">system_images = DirectDetections.Images(
    (band=:H, image=centered(images[1]), platescale=10.0, epoch=1238.6),
    (band=:H, image=centered(images[2]), platescale=10.0, epoch=1584.7),
    (band=:H, image=centered(images[3]), platescale=10.0, epoch=3220.0),
    (band=:H, image=centered(images[4]), platescale=10.0, epoch=7495.9),
    (band=:H, image=centered(images[5]), platescale=10.0, epoch=7610.4),
)</code></pre><p>Provide one entry for each image you want to sample from. Ensure that each image has been re-centered so that index <code>[0,0]</code> is the position of the star. Areas of the image where there is no data should be filled with <code>NaN</code> and will not contribute to the likelihood of your model. <code>platescale</code> should be the pixel scale of your images, in milliarseconds / pixel. <code>epoch</code> should be the Modified Julian Day (MJD) that your image was taken. You can use the <code>mjd(&quot;2021-09-09&quot;)</code> function to calculate this for you. <code>band</code> should be a symbol that matches the name you supplied when you created the <code>Planet</code>.</p><p>By default, the contrast of the images is calculated automatically, but you can supply your own contrast curve as well by also passing <code>contrast=contrast_interp(centered(my_image))</code>.</p><p>You can freely mix and match images from different instruments as long as you specify the correct platescale.  You can also provide images from multiple bands and they will be sampled independently. If you wish to tie them together, see <a href="../mass-photometry/#mass-photometry">Connecting Mass with Photometry</a>.</p><p>Finally, create the system and pass in your table of images.</p><pre><code class="language-julia hljs">@named HD82134 = System(
    Priors(
        μ = Normal(2.0, 0.1),
        plx =Normal(45., 0.02),
    ),
    system_images,
    X,
)</code></pre><h2 id="Sampling"><a class="docs-heading-anchor" href="#Sampling">Sampling</a><a id="Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Sampling" title="Permalink"></a></h2><p>Sampling from images is much more challenging than relative astrometry or proper motion anomaly, so the fitting process tends to take longer.</p><p>This is because the posterior is much &quot;bumpier&quot; with images. One way this manifests is very high tree depths. You might see a sampling report that says <code>max_tree_depth_frac = 0.9</code> or even <code>1.0</code>. To encourage the sampler to take larger steps and explore the images, it&#39;s recommended to lower the target acceptance ratio to around 0.5±0.2 and also increase the number of adapataion steps.</p><pre><code class="language-julia hljs">chain = DirectDetections.hmc(
    HD82134, 0.25,
    adaptation =   8_000,
    iterations =  10_000,
    tree_depth =      10,
);</code></pre><p>Sampling directly from images is somewhat slower than from astrometry. This example takes roughly 7 minutes on my laptop.</p><h2 id="Diagnostics"><a class="docs-heading-anchor" href="#Diagnostics">Diagnostics</a><a id="Diagnostics-1"></a><a class="docs-heading-anchor-permalink" href="#Diagnostics" title="Permalink"></a></h2><p>The first thing you should do with your results is check a few diagnostics to make sure the sampler converged as intended.</p><p>The acceptance rate should be somewhat lower than when fitting just astrometry, e.g. around the 0.6 target.</p><p>You can make a trace plot:</p><pre><code class="language-julia hljs">plot(
    chain[&quot;X[a]&quot;],
    xlabel=&quot;iteration&quot;,
    ylabel=&quot;semi-major axis (aU)&quot;
)</code></pre><p>And an auto-correlation plot:</p><pre><code class="language-julia hljs">using StatsBase
plot(
    autocor(chain[&quot;X[e]&quot;], 1:500),
    xlabel=&quot;lag&quot;,
    ylabel=&quot;autocorrelation&quot;,
)</code></pre><p>For this model, there is somewhat higher correlation between samples. Some thinning to remove this correlation is recommended. <img src="../assets/images-autocor-plot.png" alt="autocorrelation plot"/></p><h2 id="Analysis"><a class="docs-heading-anchor" href="#Analysis">Analysis</a><a id="Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Analysis" title="Permalink"></a></h2><p>You can plot the model as usual:</p><pre><code class="language-julia hljs">using Plots
plotmodel(chain)</code></pre><p><a href="../assets/images-model-plot.svg"><img src="../assets/images-model-plot.png" alt="images"/></a></p><p>In this case, the model is shown overtop a stack of the input images to help you visualize which peaks contributed to the fit. The images are stacked using the <code>maximum</code> function, so that bright spots from all images appear at once. The colour scale is inverted, so that the brightest peaks are shown in black.</p><p>You can also specify a <code>lims=1000</code> parameter to set limits of the images to +/- 1000 mas, as in this example.</p><h2 id="Pair-Plot"><a class="docs-heading-anchor" href="#Pair-Plot">Pair Plot</a><a id="Pair-Plot-1"></a><a class="docs-heading-anchor-permalink" href="#Pair-Plot" title="Permalink"></a></h2><p>We can show the relationships between variables on a pair plot (aka corner plot) using PairPlots.jl</p><pre><code class="language-julia hljs">using PairPlots
table = (;
    a=         chain[&quot;X[a]&quot;],
    H=         chain[&quot;X[H]&quot;],
    e=         chain[&quot;X[e]&quot;],
    i=rad2deg.(chain[&quot;X[i]&quot;]),
    Ω=rad2deg.(chain[&quot;X[Ω]&quot;]),
    ω=rad2deg.(chain[&quot;X[ω]&quot;]),
    τ=         chain[&quot;X[τ]&quot;],
)
labels=[
    &quot;a&quot;,
    &quot;H&quot;,
    &quot;e&quot;,
    &quot;i&quot;,
    &quot;\\Omega&quot;,
    &quot;\\omega&quot;,
    &quot;\\tau&quot;,
]
units = [
    &quot;(au)&quot;,
    &quot;(arb.)&quot;,
    &quot;&quot;,
    &quot;(\\degree)&quot;,
    &quot;(\\degree)&quot;,
    &quot;(\\degree)&quot;,
    &quot;&quot;,
]
corner(table, labels, units)</code></pre><p>Note that this time, we also show the recovered photometry in the corner plot.</p><p><a href="../assets/images-corner-plot.svg"><img src="../assets/images-corner-plot.png" alt="corner plot"/></a></p><h2 id="Assessing-Detections"><a class="docs-heading-anchor" href="#Assessing-Detections">Assessing Detections</a><a id="Assessing-Detections-1"></a><a class="docs-heading-anchor-permalink" href="#Assessing-Detections" title="Permalink"></a></h2><p>To assess a detection, we can treat all the orbital variables as nuisance parameters.  We start by plotting the marginal distribution of the flux parameter, <code>H</code>:</p><pre><code class="language-julia hljs">histogram(chain[&quot;X[H]&quot;], xlabel=&quot;H&quot;, label=&quot;&quot;)</code></pre><p><img src="../assets/images-flux-hist.png" alt="corner plot"/></p><p>We can calculate an analog of the traditional signal to noise ratio (SNR) using that same histogram:</p><pre><code class="language-julia hljs">flux = chain[&quot;X[H]&quot;]
snr = mean(flux)/std(flux) # 13.35 in this example</code></pre><p>It might be better to consider a related measure, like the median flux over the interquartile distance. This will depend on your application.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pma/">« Fit Astrometric Acceleration</a><a class="docs-footer-nextpage" href="../derived/">Derived Variables »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Tuesday 28 June 2022 12:19">Tuesday 28 June 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
